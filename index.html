<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>MÃ¡y Cáº¥p Thuá»‘c MQTT</title>
  <script src="https://unpkg.com/paho-mqtt/mqtt.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 500px; margin: auto; padding: 20px; }
    input, button, select { width: 100%; padding: 10px; margin: 10px 0; font-size: 1em; }
    .box { border: 1px solid #ccc; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    #log { white-space: pre-wrap; background: #f9f9f9; padding: 10px; border-radius: 5px; height: 120px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>ğŸ’Š MÃ¡y Cáº¥p Thuá»‘c ESP32 - HiveMQ</h2>

  <div class="box">
    <h3>ğŸ“¤ Gá»­i lá»‹ch má»›i</h3>
    <input id="time" placeholder="Thá»i gian (HH:MM)">
    <input id="slot" type="number" placeholder="Khay (0-15)">
    <input id="pills" type="number" placeholder="Sá»‘ viÃªn thuá»‘c">
    <button onclick="sendSchedule()">Gá»­i lá»‹ch</button>
  </div>

  <div class="box">
    <h3>ğŸ—‘ XoÃ¡ lá»‹ch</h3>
    <input id="deleteTime" placeholder="Thá»i gian cáº§n xoÃ¡ (HH:MM)">
    <button onclick="deleteSchedule()">XoÃ¡ lá»‹ch</button>
  </div>

  <div class="box">
    <h3>ğŸ“‹ Danh sÃ¡ch lá»‹ch hiá»‡n táº¡i</h3>
    <button onclick="requestSchedule()">ğŸ”„ YÃªu cáº§u ESP32 gá»­i danh sÃ¡ch</button>
    <pre id="scheduleList">[chÆ°a cÃ³ dá»¯ liá»‡u]</pre>
  </div>

  <div class="box">
    <h3>ğŸ”” Pháº£n há»“i tá»« ESP32</h3>
    <div id="log">Chá» ESP32 pháº£n há»“i...</div>
  </div>

  <p id="status">ğŸ”Œ Äang káº¿t ná»‘i MQTT...</p>

  <script>
    const clientID = "webform-" + Math.random().toString(16).substr(2, 8);
    const host = "4279ede62379437b88de9a4dd915ce6e.s1.eu.hivemq.cloud";
    const port = 8884;

    const client = new Paho.MQTT.Client(host, port, "/mqtt", clientID);

    client.onConnectionLost = (response) => {
      document.getElementById("status").textContent = "âŒ Máº¥t káº¿t ná»‘i MQTT";
    };

    client.onMessageArrived = (message) => {
      console.log("Message:", message);
      const topic = message.destinationName;
      const payload = message.payloadString;

      if (topic === "pill_dispenser/1/ack" || topic === "pill_dispenser/1/delete_ack") {
        log(`[âœ… ESP32]: ${payload}`);
      }

      if (topic === "pill_dispenser/1/status") {
        try {
          const data = JSON.parse(payload);
          const schedules = data.schedules || [];
          let html = "";
          schedules.forEach(s => {
            html += `â° ${s.time} | Slot ${s.slot} | ğŸ’Š ${s.pills} viÃªn\n`;
          });
          document.getElementById("scheduleList").textContent = html || "KhÃ´ng cÃ³ lá»‹ch nÃ o.";
        } catch (e) {
          log("âš ï¸ JSON lá»—i tá»« ESP32");
        }
      }
    };

    client.connect({
      userName: "Access",
      password: "Yes123456",
      useSSL: true,
      onSuccess: () => {
        document.getElementById("status").textContent = "âœ… ÄÃ£ káº¿t ná»‘i MQTT!";
        client.subscribe("pill_dispenser/1/ack");
        client.subscribe("pill_dispenser/1/delete_ack");
        client.subscribe("pill_dispenser/1/status");
        log("ğŸŸ¢ MQTT Ä‘Ã£ sáºµn sÃ ng");
      },
      onFailure: (err) => {
        document.getElementById("status").textContent = "âŒ Lá»—i káº¿t ná»‘i MQTT: " + err.errorMessage;
      }
    });

    function log(msg) {
      const logDiv = document.getElementById("log");
      logDiv.textContent += msg + "\n";
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function sendSchedule() {
      const time = document.getElementById("time").value;
      const slot = parseInt(document.getElementById("slot").value);
      const pills = parseInt(document.getElementById("pills").value);
      if (!time || isNaN(slot) || isNaN(pills)) {
        alert("Äiá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!");
        return;
      }
      const payload = JSON.stringify({ time, slot, pills });
      client.send("pill_dispenser/1/schedule", payload);
      log(`ğŸ“¤ Gá»­i lá»‹ch: ${time} - slot ${slot} - ${pills} viÃªn`);
    }

    function deleteSchedule() {
      const time = document.getElementById("deleteTime").value;
      if (!time) {
        alert("Nháº­p thá»i gian cáº§n xoÃ¡");
        return;
      }
      const payload = JSON.stringify({ time });
      client.send("pill_dispenser/1/delete_schedule", payload);
      log(`ğŸ—‘ Gá»­i yÃªu cáº§u xoÃ¡ lá»‹ch: ${time}`);
    }

    function requestSchedule() {
      // Gá»­i yÃªu cáº§u riÃªng náº¿u báº¡n muá»‘n ESP32 gá»­i láº¡i tráº¡ng thÃ¡i
      client.send("pill_dispenser/1/get_schedule", "request");
      log("ğŸ”„ ÄÃ£ yÃªu cáº§u ESP32 gá»­i danh sÃ¡ch lá»‹ch.");
    }
  </script>
</body>
</html>
